name: AI Code Review

on:
  push:
  pull_request:

jobs:
  ai_review:
    name: Analyse du code avec Gemini
    runs-on: ubuntu-latest
    permissions:
      contents: write       # NÃ©cessaire pour modifier le README (badge)
      pull-requests: write  # NÃ©cessaire pour crÃ©er des PR automatiques

    steps:
      - name: ğŸ”„ RÃ©cupÃ©ration du code du dÃ©pÃ´t
        uses: actions/checkout@v4

      - name: ğŸ Configuration de Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ğŸ“¦ Installation des dÃ©pendances
        run: |
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            echo "âš ï¸ Aucun fichier requirements.txt trouvÃ©, installation ignorÃ©e."
          fi

      - name: ğŸ¤– ExÃ©cution du reviewer IA (Gemini)
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          EMAIL_SENDER: ${{ secrets.EMAIL_SENDER }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPO: ${{ github.repository }}
        run: |
          echo "ğŸ” Lancement de l'analyse IA..."
          python ai_code_reviewer.py || {
            echo "âŒ L'IA a dÃ©tectÃ© des erreurs dans le code."
            exit 1
          }

      - name: ğŸ§¾ VÃ©rification du rapport PDF
        id: check_pdf
        run: |
          if [ -f ai_report.pdf ]; then
            echo "file_exists=true" >> $GITHUB_OUTPUT
          else
            echo "file_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ§¾ Upload du rapport PDF (si gÃ©nÃ©rÃ©)
        if: steps.check_pdf.outputs.file_exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: AI-Review-Report
          path: ai_report.pdf

      - name: ğŸ·ï¸ Mise Ã  jour du badge AI Review dans le README
        if: always()
        run: |
          STATUS="âŒ Ã‰chec"
          COLOR="red"
          if [ "${{ job.status }}" == "success" ]; then
            STATUS="âœ… SuccÃ¨s"
            COLOR="green"
          fi
          BADGE_URL="https://img.shields.io/badge/AI%20Code%20Review-${STATUS// /%20}-${COLOR}?style=for-the-badge"
          sed -i '/AI Code Review/d' README.md || true
          echo "![](${BADGE_URL})" >> README.md
          git config user.name "AI Reviewer Bot"
          git config user.email "ai-reviewer@github.com"
          git add README.md
          git commit -m "ğŸ”„ Mise Ã  jour automatique du badge AI Code Review" || echo "Aucun changement Ã  committer"
          git push origin HEAD:${{ github.ref }}

      - name: ğŸ” CrÃ©ation automatique dâ€™une Pull Request si push refusÃ©
        if: failure()
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ai-review-fix-${{ github.run_id }}
          title: "ğŸš¨ Correction automatique suite Ã  une erreur IA"
          body: |
            Lâ€™analyse IA a dÃ©tectÃ© des erreurs dans le code.
            Consulte le rapport PDF joint et corrige les problÃ¨mes avant validation.
